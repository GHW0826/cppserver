cmake_minimum_required(VERSION 3.19)
project(Server LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

if (CMAKE_SIZEOF_VOID_P EQUAL 8)
    set(ARCH_DIR "x64")
elseif (CMAKE_SIZEOF_VOID_P EQUAL 4)
    set(ARCH_DIR "x86")
else()
    set(ARCH_DIR "unknown")
endif()

if (NOT CMAKE_CONFIGURATION_TYPES)
    if (NOT CMAKE_BUILD_TYPE)
        set(CMAKE_BUILD_TYPE Debug CACHE STRING "Build type" FORCE)
    endif()
    set(PROTO_CONFIG_DIR "${CMAKE_BUILD_TYPE}")
else()
    set(PROTO_CONFIG_DIR "$<CONFIG>")
endif()

set(ROOT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/..")


# Core Lib Source (Generated by Python)
set(CORE_SOURCES
"${CMAKE_CURRENT_SOURCE_DIR}/Core/CoreGlobal.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/CorePch.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/CoreTLS.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Job/GlobalQueue.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Job/Job.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Job/JobQueue.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Job/JobTimer.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Lock/CustomLock.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Lock/CustomReadLockGuard.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Lock/CustomWriteLockGuard.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Lock/DeadLockProfiler.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Allocator/PoolAllocator.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Allocator/STLAllocator.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Buffer/RecvBuffer.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Buffer/SendBuffer.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Buffer/SendBufferChunk.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Buffer/SendBufferManager.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Memory.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/MemoryPool.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/SmartPointer/CustomEnableSharedFromThis.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/Epoll/EpollCore.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/Epoll/EpollEvent.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/Epoll/EpollListener.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/Epoll/EpollObject.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/Epoll/EpollSession.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/IOCP/IOCPCore.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/IOCP/IOCPEvent.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/IOCP/IOCPListener.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/IOCP/IOCPObject.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/IOCP/IOCPSession.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/NetAddress.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/PacketSession.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/Service.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/SocketUtil.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/SocketUtil_posix.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/SocketUtil_win.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Protocol/CorePacketHandler.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Thread/ThreadManager.cpp"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/pch.cpp"

)

# Create static Lib
add_library(Core STATIC ${CORE_SOURCES})

set(PROTOBUF_INCLUDE_DIR "${ROOT_DIR}/Include/Protobuf")
set(PROTOBUF_LIB_DIR "${ROOT_DIR}/Lib/Protobuf/${PROTO_CONFIG_DIR}/${ARCH_DIR}")

set(PROTOBUF_LIB_PATH "${PROTOBUF_LIB_DIR}/libprotobuf.a")
if (EXISTS "${PROTOBUF_LIB_DIR}/libprotobufd.a")
    set(PROTOBUF_LIB_PATH "${PROTOBUF_LIB_DIR}/libprotobufd.a")
endif()

add_library(Protobuf::libprotobuf STATIC IMPORTED GLOBAL)
set_target_properties(Protobuf::libprotobuf PROPERTIES
    IMPORTED_LOCATION "${PROTOBUF_LIB_PATH}"
    INTERFACE_INCLUDE_DIRECTORIES "${PROTOBUF_INCLUDE_DIR}"
)

target_link_libraries(Core PUBLIC Protobuf::libprotobuf)
if (UNIX AND NOT APPLE)
    find_package(Threads REQUIRED)
    target_link_libraries(Core PUBLIC Threads::Threads dl)
endif()


# header include path
target_include_directories(Core PUBLIC
"${CMAKE_CURRENT_SOURCE_DIR}/Include/Protobuf"
"${CMAKE_CURRENT_SOURCE_DIR}/Core"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Core"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Job"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Lock"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Allocator"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/Buffer"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Memory/SmartPointer"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/Epoll"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Network/IOCP"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Protocol"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Protocol/Protobuf"
"${CMAKE_CURRENT_SOURCE_DIR}/Core/Thread"

)

# ===== Already Compiled Header Set (CMake 3.16+ Recommand) =====
target_precompile_headers(Core PRIVATE
    "$<$<COMPILE_LANGUAGE:CXX>:pch.h>"
)

# Core Lib Output Path
set_target_properties(Core PROPERTIES
    ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/../../Lib/Core/${CMAKE_BUILD_TYPE}/${ARCH_DIR}"
)

set(CORE_HEADERS_DST_ROOT "${ROOT_DIR}/Include/Core")

add_custom_command(TARGET Core POST_BUILD
    COMMAND "${CMAKE_COMMAND}" -E make_directory "${CORE_HEADERS_DST_ROOT}"
    COMMAND "${CMAKE_COMMAND}" -E copy_directory "${CMAKE_CURRENT_SOURCE_DIR}" "${CORE_HEADERS_DST_ROOT}"
    COMMENT "Copy Core tree -> ${CORE_HEADERS_DST_ROOT}"
    VERBATIM
)